# 📘 Chapter 3: 도커의 이미지 만들기

## 3-1. 도커 허브에 공유된 이미지 사용하기

2장에서 `docker container run` 명령을 사용할 때 필요한 이미지 중 로컬 컴퓨터에 없는 이미지가 있으면 이미지를 내려받았습니다. 이미지를 내려받는 과정을 저번과 같이 도커에 전적으로 맡길 수도 있지만, 도커 CLI를 통해 명시적으로 원하는 이미지를 내려받을 수도 있습니다.

### 이미지 직접 내려받기

```bash
docker image pull diamol/ch03-web-ping
```

해당 이미지(`diamol/ch03-web-ping`)는 도커가 가장 먼저 이미지를 찾기 위해 접근하는 저장소인 **도커 허브**에 저장되어 있습니다. 이미지를 제공하는 저장소를 **레지스트리**라고 하며, 도커 허브는 무료로 제공되는 공개 레지스트리입니다.

```bash
Using default tag: latest
latest: Pulling from diamol/ch03-web-ping
0362ad1dd800: Already exists
b09a182c47e8: Already exists
39d61d2ed871: Already exists
b4e2115e274a: Already exists
f5cca017994f: Pull complete
f504555623f6: Pull complete
Digest: sha256:2f2dce710a7f287afc2d7bbd0d68d024bab5ee37a1f658cef46c64b1a69affd2
Status: Downloaded newer image for diamol/ch03-web-ping:latest
docker.io/diamol/ch03-web-ping:latest
```

이미지를 내려받는 과정을 보면 **여러 건의 파일을 동시에 내려받는다**는 점에서 단일 파일을 내려받는 과정이 아니라는 것을 알 수 있습니다.

### 환경 변수를 이용한 컨테이너 설정

**환경 변수**는 OS에서 제공하는 키-값 쌍입니다. 아주 적은 양의 데이터를 저장하는 데 유용합니다. 도커 컨테이너도 별도의 환경 변수를 가질 수 있습니다. 그러나 이 환경 변수는 호스트 OS의 것이 아니라 컨테이너의 호스트명이나 IP 주소처럼 도커가 부여해 줍니다.

**기본 설정으로 실행:**

```bash
docker container run diamol/ch03-web-ping
```

**환경 변수를 설정하여 실행:**

```bash
docker container run --env TARGET=google.com diamol/ch03-web-ping
```

도커 이미지는 설정값의 기본값을 포함해 패키징되지만, **컨테이너를 실행할 때 이 설정값을 바꿀 수 있어야** 합니다. 유연한 이미지를 만드는 것이 좋고, 이는 이미지 제작자가 결정할 일입니다.

## 3-2. Dockerfile 작성하기

Dockerfile은 애플리케이션을 패키징하기 위한 간단한 스크립트입니다.  
 일련의 인스트럭션으로 구성되어 있는데, 인스트럭션을 실행한 결과로 도커 이미지가 만들어집니다.

앞선 3-1 예제의 도커파일은 다음과 같습니다:

```dockerfile
FROM diamol/node

ENV TARGET="blog.sixeyed.com"
ENV METHOD="HEAD"
ENV INTERVAL="3000"

WORKDIR /web-ping
COPY app.js .

CMD ["node", "/web-ping/app.js"]
```

#### 1. FROM: 베이스 이미지 지정

```dockerfile
FROM diamol/node
```

**모든 이미지는 다른 이미지로부터 출발합니다.**
이 이미지는 `diamol/node` 이미지를 시작점으로 지정합니다.  
`diamol/node`에는 Node.js가 설치되어 있습니다.

FROM은 항상 Dockerfile의 첫 번째 인스트럭션이어야 합니다. 베이스 이미지는 우리가 만들 이미지의 기반이 되는 운영체제와 런타임 환경을 제공합니다.

#### 2. ENV: 환경 변수 설정

```dockerfile
ENV TARGET="blog.sixeyed.com"
ENV METHOD="HEAD"
ENV INTERVAL="3000"
```

**환경 변수 값을 지정하기 위한 인스트럭션**으로 키=값 형식을 따릅니다.

- `TARGET`: 핑을 보낼 대상 웹사이트
- `METHOD`: HTTP 요청 방식
- `INTERVAL`: 핑을 보내는 간격 (밀리초)

#### 3. WORKDIR: 작업 디렉터리 설정

```dockerfile
WORKDIR /web-ping
```

**컨테이너 이미지 파일 시스템에 디렉터리를 만들고, 해당 디렉터리를 작업 디렉터리로 지정**하는 인스트럭션입니다.  
 이후의 모든 명령은 이 디렉터리를 기준으로 실행됩니다.

#### 4. COPY: 파일 복사

```dockerfile
COPY app.js .
```

**로컬 파일 시스템의 파일, 디렉터리를 컨테이너 이미지로 복사**하는 인스트럭션입니다.  
`원본경로 복사경로` 형식으로 지정합니다.

- `app.js`: 현재 디렉터리의 app.js 파일
- `.`: 현재 작업 디렉터리(/web-ping)로 복사

#### 5. CMD: 기본 실행 명령

```dockerfile
CMD ["node", "/web-ping/app.js"]
```

**도커가 이미지로부터 컨테이너를 실행했을 때 실행할 명령을 지정**하는 인스트럭션입니다.  
 JSON 배열 형식으로 작성합니다.

## 3-3. 컨테이너 이미지 빌드하기

dockerfile, 애플리케이션과 같은 경로에 있으면 이미지 빌드를 할 수 있습니다.

```bash
docker image build --tag web-ping
```

빌드된 이미지는 로컬 이미지 캐시에 저장됩니다.  
이 이미지는 도커 허브에서 내려받은 이미지와 똑같이 사용 가능합니다.

## 3-4. 도커 이미지와 이미지 레이어 이해하기

도커 이미지에는 우리가 패키징에 포함시킨 모든 파일이 들어 있습니다.  
이들 파일은 나중에 컨테이너의 파일 시스템을 형성합니다.  
이 외에도 이미지에는 여러 **메타데이터 정보**가 들어 있는데, 이 정보를 이용하면 이미지를 구성하는 각 레이어는 무엇이고 어떤 명령으로 빌드되었는지 확인할 수 있습니다.

**도커 이미지는 이미지 레이어가 모인 논리적 대상**입니다.  
레이어는 도커 엔진의 캐시에 물리적으로 저장된 파일입니다.

```
도커 이미지 (논리적)
┌─────────────────────┐
│     app.js 파일      │ ← Layer 4 (COPY 명령)
├─────────────────────┤
│   환경변수 설정       │ ← Layer 3 (ENV 명령)
├─────────────────────┤
│   작업 디렉터리       │ ← Layer 2 (WORKDIR 명령)
├─────────────────────┤
│   Node.js 런타임     │ ← Layer 1 (FROM 명령)
└─────────────────────┘
      물리적 저장소에 각각 저장
```

### 레이어 공유의 중요성

**이미지 레이어는 여러 이미지와 컨테이너에서 공유되기 때문에 중요**합니다.  
만약 Node.js 애플리케이션이 실행되는 컨테이너를 여러 개 실행한다면, 이들 컨테이너는 모두 Node.js 런타임이 들어 있는 이미지 레이어를 공유합니다.

#### 레이어 공유 예시

```bash
# 첫 번째 Node.js 앱
FROM node:22
COPY app1.js .
CMD ["node", "app1.js"]

# 두 번째 Node.js 앱
FROM node:22
COPY app2.js .
CMD ["node", "app2.js"]

# 세 번째 Node.js 앱
FROM node:22
COPY app3.js .
CMD ["node", "app3.js"]
```

이 경우 `node:22` 베이스 이미지 레이어는 **한 번만 다운로드**되고 **세 이미지가 모두 공유**합니다.

```
메모리/디스크 사용량:
┌──────────────────┐
│  node:16 레이어   │ ← 한 번만 저장 (공유)
├──────────────────┤
│   app1.js 레이어  │ ← 앱1 전용
├──────────────────┤
│   app2.js 레이어  │ ← 앱2 전용
├──────────────────┤
│   app3.js 레이어  │ ← 앱3 전용
└──────────────────┘
```

**이미지 레이어를 여러 이미지가 공유하기 때문에 공유되는 레이어는 수정할 수 없어야** 합니다.  
만약 이미지 레이어를 수정할 수 있다면 다른 이미지에도 영향을 미칩니다.

**도커는 이미지 레이어를 읽기 전용으로 만들어 이를 방지**합니다.  
이미지를 빌드하며 레이어가 만들어지면 다른 이미지에서 재사용될 수 있지만, 수정할 수는 없습니다.

### 레이어 캐싱과 빌드 최적화

도커는 레이어 캐싱을 통해 빌드 시간을 단축합니다:

```dockerfile
# 효율적
FROM node:16                    # 거의 변경되지 않음
WORKDIR /app                    # 거의 변경되지 않음
COPY package*.json ./           # 가끔 변경됨
RUN npm install                 # 패키지가 변경될 때만 재실행
COPY . .                       # 자주 변경됨 (소스 코드)
CMD ["npm", "start"]           # 거의 변경되지 않음
```

```dockerfile
# 비효율적
FROM node:16
COPY . .                       # 소스 코드가 변경되면
RUN npm install                 # npm install도 매번 재실행됨
WORKDIR /app
CMD ["npm", "start"]
```
